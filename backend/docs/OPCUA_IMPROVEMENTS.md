# OPC UA Service Improvements

## Проблема
Приложение испытывало циклические проблемы с подключением к OPC UA серверу:
- `BadSessionIdInvalid` - клиент пытался использовать невалидную сессию
- `TimeoutError` - запросы не получали ответа
- Ошибки в watchdog loop
- Бесконечный цикл переподключений

## Решение

### 1. Жесткий сброс при ошибках сессии
При получении `BadSessionIdInvalid`, `BadSessionClosed` или `BadSessionNotActivated`:
- Не пытаемся отключаться (это вызывало дополнительные ошибки)
- Просто отбрасываем клиент: `self._client = None`
- Сбрасываем состояние и переподключаемся

### 2. Увеличенные таймауты (на основе asyncua best practices)
```python
client.session_timeout = 60000  # 60 секунд
client.secure_channel_timeout = 3600000  # 1 час
```

### 3. Экспоненциальная задержка при переподключении
- Первая попытка: сразу
- Вторая попытка: через 2 секунды
- Третья попытка: через 4 секунды
- Максимум: 60 секунд между попытками

### 4. Таймауты на операции
- Подключение: 20 секунд
- Чтение узла: 5 секунд
- Отключение: 2 секунды
- Health check: 5 секунд

### 5. Улучшенная обработка ошибок
- **Ошибки сессии** → жесткий сброс без отключения
- **Ошибки соединения** → попытка корректного отключения
- **Ошибки узлов** → добавление в черный список
- **Таймауты** → жесткий сброс

### 6. Использование стандартных ObjectIds
```python
from asyncua import ua
root = client.get_node(ua.ObjectIds.RootFolder)
```

### 7. Параллельное чтение узлов
Добавлены два метода для эффективного чтения множества узлов:

#### `read_nodes()` - для небольших наборов (1-10 узлов)
```python
# Использует asyncio.gather для параллельного чтения
results = await opcua_service.read_nodes([
    "ns=2;s=Variable1",
    "ns=2;s=Variable2",
    "ns=2;s=Variable3"
])
```

#### `read_nodes_batch()` - для больших наборов (>10 узлов)
```python
# Оптимизированное пакетное чтение
results = await opcua_service.read_nodes_batch([
    "ns=2;s=Variable1",
    "ns=2;s=Variable2",
    # ... много узлов
])
```

Преимущества пакетного чтения:
- Все узлы читаются параллельно
- Автоматическое кеширование результатов
- Фильтрация узлов из черного списка
- Обработка ошибок для каждого узла отдельно
- Не блокирует при ошибке одного узла

## Источники
Реализация основана на официальной документации asyncua:
- High Availability Client configuration
- Session timeout best practices
- Reconnection strategies
- Error handling patterns
- Parallel operations with asyncio.gather

## Мониторинг
Диагностика теперь включает:
- `reconnect_attempts` - количество попыток переподключения
- `blacklisted_nodes` - количество проблемных узлов
- `state` - текущее состояние соединения
- `stats` - статистика операций

## Рекомендации
1. Проверьте стабильность сети между клиентом и сервером
2. Убедитесь, что OPC UA сервер не перезагружается
3. Проверьте настройки Session Timeout на сервере
4. Мониторьте логи на предмет повторяющихся ошибок
5. Используйте `read_nodes_batch()` для чтения большого количества узлов
6. Рассмотрите использование subscriptions для real-time мониторинга вместо polling
